<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Alunos - Sistema de Presen√ßa</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 1.2rem;
            color: #8c8c8c;
        }
        .auth-protected { display: none; }
    </style>
</head>
<body>
    <div id="authLoading" class="auth-loading">
        <div>üîí Verificando autentica√ß√£o...</div>
    </div>
    <div class="container auth-protected" id="mainContent">
        <header>
            <div class="header-content">
                <div>
                    <h1>üë• Cadastro de Alunos</h1>
                    <nav class="breadcrumb">
                        <a href="index.html">In√≠cio</a> &gt; Cadastro de Alunos
                    </nav>
                </div>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <span id="syncStatus" style="margin-right: 15px; font-size: 0.9rem; color: #4caf50;">
                        ‚òÅÔ∏è Sincronizado
                    </span>
                    <span id="userName"></span>
                    <button onclick="handleLogout()" class="btn-logout">Sair</button>
                </div>
            </div>
        </header>

        <div class="content">
            <div class="form-section">
                <h2>Adicionar Novo Aluno</h2>
                <form id="studentForm">
                    <div class="form-group">
                        <label for="studentName">Nome do Aluno *</label>
                        <input type="text" id="studentName" required placeholder="Digite o nome completo">
                    </div>
                    
                    <div class="form-group">
                        <label for="studentPhone">Telefone *</label>
                        <input type="tel" id="studentPhone" required placeholder="(00) 00000-0000">
                    </div>
                    
                    <div class="form-group">
                        <label for="studentModule">M√≥dulo Inicial *</label>
                        <select id="studentModule" required>
                            <option value="1">M√≥dulo 1</option>
                            <option value="2">M√≥dulo 2</option>
                            <option value="3">M√≥dulo 3</option>
                            <option value="4">M√≥dulo 4</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <span class="icon">‚ûï</span> Adicionar Aluno
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <span class="icon">üîÑ</span> Limpar
                        </button>
                    </div>
                </form>
            </div>

            <div class="list-section">
                <div class="section-header">
                    <h2>Alunos Cadastrados</h2>
                    <div class="header-actions">
                        <div class="import-export-buttons">
                            <button class="btn btn-primary btn-small" onclick="document.getElementById('importFileInput').click()">
                                üì§ Importar Alunos
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportStudentsJSON()">
                                üì• Exportar JSON
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportStudentsCSV()">
                                üìä Exportar CSV
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="exportStudentsPDF()">
                                üìÑ Exportar PDF
                            </button>
                            <input type="file" id="importFileInput" accept=".json,.csv" style="display: none;" onchange="handleImportFile(event)">
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchStudent" placeholder="üîç Buscar aluno...">
                        </div>
                    </div>
                </div>

                <div class="stats-summary" id="studentStats">
                    <div class="stat-item">
                        <span class="stat-label">Total de Alunos:</span>
                        <span class="stat-value" id="totalStudents">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">M√≥dulo 1:</span>
                        <span class="stat-value" id="module1Count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">M√≥dulo 2:</span>
                        <span class="stat-value" id="module2Count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">M√≥dulo 3:</span>
                        <span class="stat-value" id="module3Count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">M√≥dulo 4:</span>
                        <span class="stat-value" id="module4Count">0</span>
                    </div>
                </div>

                <table class="students-table" id="studentsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>M√≥dulo Atual</th>
                            <th>Data de Cadastro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <tr class="empty-state">
                            <td colspan="6">Nenhum aluno cadastrado ainda. Adicione o primeiro aluno acima.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <a href="index.html" class="btn btn-secondary">‚¨ÖÔ∏è Voltar ao In√≠cio</a>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Aluno</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editStudentForm">
                <input type="hidden" id="editStudentId">
                <div class="form-group">
                    <label for="editStudentName">Nome do Aluno *</label>
                    <input type="text" id="editStudentName" required>
                </div>
                <div class="form-group">
                    <label for="editStudentPhone">Telefone *</label>
                    <input type="tel" id="editStudentPhone" required>
                </div>
                <div class="form-group">
                    <label for="editStudentModule">M√≥dulo Atual *</label>
                    <select id="editStudentModule" required>
                        <option value="1">M√≥dulo 1</option>
                        <option value="2">M√≥dulo 2</option>
                        <option value="3">M√≥dulo 3</option>
                        <option value="4">M√≥dulo 4</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { requireAuth, logout } from './js/auth.js';
        import DataManager from './js/data.js';
        import { initStudentsPage } from './js/students.js';

        // Require authentication
        requireAuth().then(async (user) => {
            // Hide loading, show content
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('userName').textContent = user.displayName || user.email;
            
            // Initialize DataManager
            await DataManager.init();
            
            // Initialize students page
            await initStudentsPage();
            
            // Listen for sync status updates
            window.addEventListener('firebase-sync', (event) => {
                const statusEl = document.getElementById('syncStatus');
                if (!statusEl) return;
                
                switch(event.detail.status) {
                    case 'syncing':
                        statusEl.innerHTML = 'üîÑ Sincronizando...';
                        statusEl.style.color = '#2196f3';
                        break;
                    case 'synced':
                        statusEl.innerHTML = '‚òÅÔ∏è Sincronizado';
                        statusEl.style.color = '#4caf50';
                        break;
                    case 'error':
                        statusEl.innerHTML = '‚ö†Ô∏è Offline';
                        statusEl.style.color = '#ff9800';
                        break;
                }
            });
        });

        window.handleLogout = async () => {
            if (confirm('Deseja realmente sair?')) await logout();
        };
    </script>
</body>
</html>
