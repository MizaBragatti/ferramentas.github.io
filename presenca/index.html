<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Presen√ßa - Aulas Musicais</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 1.2rem;
            color: #8c8c8c;
        }
        .auth-protected { display: none; }
    </style>
</head>
<body>
    <div id="authLoading" class="auth-loading">
        <div>üîí Verificando autentica√ß√£o...</div>
    </div>
    <div class="container auth-protected" id="mainContent">
        <header>
            <div class="header-content">
                <div>
                    <h1>üéµ Sistema de Presen√ßa</h1>
                    <p class="subtitle">Gest√£o de Aulas Musicais aos S√°bados</p>
                </div>
                <div class="user-menu" id="userMenu" style="display: none;">
                    <span id="userName"></span>
                    <button onclick="handleLogout()" class="btn-logout">Sair</button>
                </div>
            </div>
        </header>

        <nav class="main-nav">
            <a href="presenca.html" class="nav-button">
                <span class="icon">üìã</span>
                <span>Marcar Presen√ßa</span>
            </a>
            <a href="cadastro.html" class="nav-button">
                <span class="icon">üë•</span>
                <span>Cadastro de Alunos</span>
            </a>
            <a href="reports.html" class="nav-button">
                <span class="icon">üìä</span>
                <span>Relat√≥rios</span>
            </a>
            <a href="modulos.html" class="nav-button">
                <span class="icon">üìö</span>
                <span>Gest√£o de M√≥dulos</span>
            </a>
        </nav>

        <div class="welcome-section">
            <h2>Bem-vindo ao Sistema de Controle de Presen√ßa</h2>
            <p>Sistema para gerenciar presen√ßa em aulas musicais com controle modular.</p>
            
            <div class="info-cards">
                <div class="info-card">
                    <h3>‚òÅÔ∏è Dados na Nuvem</h3>
                    <ul>
                        <li><strong>Firebase Realtime Database</strong></li>
                        <li>Acesse de qualquer dispositivo</li>
                        <li>Sincroniza√ß√£o autom√°tica</li>
                        <li>Backup autom√°tico</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>‚ö†Ô∏è Sistema de Alertas</h3>
                    <ul>
                        <li><strong class="warning">25% de faltas:</strong> Aviso preventivo</li>
                        <li><strong class="critical">40% de faltas:</strong> Deve repetir m√≥dulo</li>
                        <li>C√°lculo autom√°tico por m√≥dulo</li>
                    </ul>
                </div>
                
                <div class="info-card">
                    <h3>üìä Funcionalidades</h3>
                    <ul>
                        <li>Cadastro de alunos com ID autom√°tico</li>
                        <li>Registro de presen√ßa por m√≥dulo/fase</li>
                        <li>Relat√≥rios detalhados de frequ√™ncia</li>
                        <li>Exporta√ß√£o de dados</li>
                    </ul>
                </div>
            </div>
        </div>

        <footer>
            <p>Sistema de Presen√ßa - Aulas Musicais &copy; 2025</p>
        </footer>
    </div>

    <script type="module">
        import { requireAuth, logout } from './js/auth.js';
        import DataManager from './js/data.js';
        import { database } from './js/firebase-config.js';
        import { ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Migration function - run ONCE to move students to shared location
        window.migrarAlunosParaShared = async function() {
            try {
                const user = requireAuth.__lastUser;
                if (!user) {
                    console.error('Usu√°rio n√£o autenticado');
                    return;
                }

                console.log('üîÑ Iniciando migra√ß√£o de alunos para shared/students...');

                // Get students from old location
                const oldPath = `users/${user.uid}/${DataManager.KEYS.STUDENTS}`;
                const oldRef = ref(database, oldPath);
                const oldSnapshot = await get(oldRef);

                if (!oldSnapshot.exists()) {
                    console.log('‚úÖ Nenhum aluno encontrado no local antigo');
                    return { success: true, message: 'Nenhum dado para migrar' };
                }

                const students = oldSnapshot.val();
                console.log(`üì¶ Encontrados ${Array.isArray(students) ? students.length : Object.keys(students).length} alunos`);

                // Save to new shared location
                const sharedRef = ref(database, 'shared/students');
                await set(sharedRef, students);
                console.log('‚úÖ Alunos copiados para shared/students');

                // Clear localStorage cache to force reload from Firebase
                localStorage.removeItem(DataManager.KEYS.STUDENTS);
                console.log('üóëÔ∏è Cache local limpo');

                alert('‚úÖ Migra√ß√£o conclu√≠da! Os alunos agora est√£o dispon√≠veis para todos os usu√°rios.');
                return { success: true, message: 'Migra√ß√£o conclu√≠da' };
            } catch (error) {
                console.error('‚ùå Erro na migra√ß√£o:', error);
                alert('‚ùå Erro na migra√ß√£o: ' + error.message);
                return { success: false, error: error.message };
            }
        };

        // Require authentication
        requireAuth().then(async (user) => {
            // Save user for migration
            requireAuth.__lastUser = user;
            
            // Hide loading, show content
            document.getElementById('authLoading').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // Show user menu
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('userName').textContent = user.displayName || user.email;
            
            // Initialize data (Firebase only)
            await DataManager.init();
            console.log('Sistema inicializado - usando Firebase como fonte de dados');
            
            // Show migration instructions in console
            console.log('üì¢ IMPORTANTE: Para migrar alunos existentes para a estrutura compartilhada, execute no console:');
            console.log('   migrarAlunosParaShared()');
        }).catch(() => {
            // Redirects to login automatically
        });

        // Logout handler
        window.handleLogout = async () => {
            if (confirm('Deseja realmente sair?')) {
                await logout();
            }
        };
    </script>
</body>
</html>
